<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üõçÔ∏è Shopping Hub</title>
  <meta name="description" content="Browse and order products across categories - clothes, study materials, cosmetics, electronics and more for college students." />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    /* ------- Reset & Base ------- */
    *{margin:0;padding:0;box-sizing:border-box;}
    body{
      font-family:'Poppins',system-ui,-apple-system,sans-serif;
      background:#f3f4f6;color:#111827;
      min-height:100vh;line-height:1.5;
    }
    .container{max-width:1200px;margin:auto;padding:20px;}
    h1{text-align:center;font-size:2rem;font-weight:700;margin-bottom:8px;}
    .subtitle{text-align:center;color:#6b7280;margin-bottom:20px;}
    .category-section,.back-section,.items-section{text-align:center;margin-bottom:20px;}
    .category-label{display:block;font-size:1rem;color:#6b7280;margin-bottom:8px;}
    .select-field{
      width:100%;max-width:300px;padding:8px 12px;
      border:1px solid #d1d5db;border-radius:6px;
      background:#fff;color:#111827;
    }
    .select-field:focus{outline:none;border-color:#4b5563;}
    .status{text-align:center;color:#6b7280;margin-bottom:10px;}
    .category-title{text-align:center;font-size:1.5rem;color:#111827;margin-bottom:16px;}
    .search-container{
      display:flex;gap:8px;max-width:500px;margin:0 auto 20px;
      flex-wrap:wrap;justify-content:center;
    }
    .search-wrapper{position:relative;flex:1;min-width:200px;}
    .search-icon{position:absolute;left:8px;top:50%;transform:translateY(-50%);color:#9ca3af;}
    .search-input{
      width:100%;padding:8px 12px 8px 30px;
      border:1px solid #d1d5db;border-radius:6px;
      background:#fff;color:#111827;
    }
    .search-input:focus{outline:none;border-color:#4b5563;}
    .btn-primary,.btn-secondary,.btn-success,.btn-order{
      padding:8px 16px;border:none;border-radius:6px;
      font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:4px;
    }
    .btn-primary{background:#2563eb;color:#fff;}
    .btn-primary:hover{background:#1d4ed8;}
    .btn-secondary{background:#e5e7eb;color:#111827;}
    .btn-secondary:hover{background:#d1d5db;}
    .btn-success{background:#10b981;color:#fff;}
    .btn-success:hover{background:#059669;}
    .btn-order{background:#2563eb;color:#fff;}
    .btn-order:hover{background:#1d4ed8;}
    .btn-order:disabled{background:#9ca3af;cursor:not-allowed;}
    .items-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;}
    .item-card{
      border:1px solid #d1d5db;border-radius:8px;
      background:#fff;overflow:hidden;display:flex;flex-direction:column;
    }
    .item-card:hover{border-color:#6b7280;}
    .image-container{height:180px;background:#d1d5db;position:relative;overflow:hidden;}
    .item-image{width:100%;height:100%;object-fit:cover;}
    .zoom-btn{
      position:absolute;top:8px;right:8px;padding:6px;
      background:#6b7280;color:#fff;border:none;
      border-radius:4px;cursor:pointer;opacity:0.8;
    }
    .zoom-btn:hover{background:#111827;}
    .card-content{padding:12px;flex:1;display:flex;flex-direction:column;}
    .item-title{font-size:1rem;font-weight:600;margin-bottom:4px;color:#111827;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    .item-price{font-size:0.9rem;font-weight:600;color:#2563eb;margin-bottom:8px;}
    .details-scrollable{max-height:120px;overflow-y:auto;margin-bottom:8px;font-size:0.8rem;color:#111827;}
    .detail-row{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:4px;}
    .detail-key{font-weight:600;color:#2563eb;}
    .detail-value a{color:#2563eb;text-decoration:underline;}
    .detail-value a:hover{color:#1d4ed8;}
    .card-actions{margin-top:auto;display:flex;flex-direction:column;gap:6px;}
    .load-more{text-align:center;color:#6b7280;margin:20px 0;display:none;}
    .spinner{
      display:inline-block;width:12px;height:12px;
      border:2px solid #d1d5db;border-top-color:#111827;
      border-radius:50%;margin-right:6px;
      animation:spin 1s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg);}}
    .no-items{text-align:center;padding:40px;color:#6b7280;font-size:1rem;}
    /* ------- Modals ------- */
    .modal-overlay{
      position:fixed;inset:0;background:rgba(0,0,0,0.5);
      display:none;align-items:center;justify-content:center;padding:20px;
      z-index:100;
    }
    .modal-overlay.active{display:flex;}
    .image-viewer-controls{
      position:absolute;top:10px;right:10px;
      display:flex;gap:4px;z-index:10;
    }
    .viewer-btn{
      padding:6px;background:#fff;border:none;
      border-radius:4px;color:#111827;cursor:pointer;
    }
    .viewer-btn:hover{background:#e5e7eb;}
    .viewer-btn.close{background:#ef4444;color:#fff;}
    .viewer-btn.close:hover{background:#dc2626;}
    .image-viewer-content img{
      max-width:90vw;max-height:80vh;border-radius:8px;
    }
    .image-viewer-info{
      position:absolute;bottom:10px;left:50%;
      transform:translateX(-50%);
      background:rgba(255,255,255,0.9);padding:4px 8px;
      border-radius:4px;font-size:0.875rem;color:#111827;
    }
    .archive-viewer{
      padding:0;
      align-items:flex-start;
      justify-content:flex-start;
    }
    .archive-viewer .viewer-btn.close{
      position:absolute;top:20px;right:20px;z-index:10;
    }
    .archive-viewer iframe{
      width:100vw;height:100vh;border:none;
    }
    .order-modal-content{
      background:#fff;padding:20px;border-radius:8px;
      width:100%;max-width:400px;
    }
    .order-modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}
    .close-modal{background:transparent;color:#111827;border:none;cursor:pointer;padding:4px;}
    .close-modal:hover{color:#2563eb;}
    .order-item-name{font-size:0.9rem;color:#6b7280;margin-bottom:12px;}
    .input-field{
      width:100%;padding:8px 12px;
      border:1px solid #d1d5db;border-radius:6px;
      background:#fff;color:#111827;
    }
    .input-field:focus{outline:none;border-color:#4b5563;}
    .form-buttons{display:flex;gap:8px;margin-top:8px;}
    .order-message{text-align:center;margin-top:8px;font-size:0.85rem;}
    .order-message.success{color:#10b981;}
    .order-message.error{color:#dc2626;}
    /* ------- Feedback Button & Modal ------- */
    .feedback-btn{
      position:fixed;right:20px;bottom:20px;
      background:#2563eb;color:#fff;border:none;
      border-radius:50%;width:56px;height:56px;
      font-size:24px;display:flex;align-items:center;justify-content:center;
      cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,0.3);z-index:1000;
    }
    .feedback-btn:hover{background:#1d4ed8;}
    /* ------- Home Icon ------- */
    .home-icon {
      position: absolute;
      top: 20px;
      left: 20px;
      font-size: 24px;
      text-decoration: none;
      color: #111827;
      z-index: 100;
    }
    .home-icon:hover {
      color: #2563eb;
    }
    /* ------- Footer ------- */
    .footer{
      position:fixed;bottom:0;left:50%;transform:translateX(-50%);
      width:100%;max-width:1200px;
      text-align:center;color:#6b7280;background:rgba(255,255,255,0.9);
      padding:8px 0;font-size:0.875rem;z-index:900;
    }
    .footer a{color:#6b7280;text-decoration:none;}
    /* ------- Hide sections by default ------- */
    .items-section{display:none;}
    .back-section{display:none;}
  </style>
</head>

<body>
  <!-- Home Icon -->
  <a href="https://yan-shun-081.github.io/yan-1-website.com/" class="home-icon" title="Home">üè†</a>

  <div class="container">
    <h1>üõí Shopping Hub</h1>
    <p class="subtitle">Browse and order products across categories</p>

    <!-- Global Search -->
    <div id="globalSearch" class="search-container">
      <div class="search-wrapper">
        <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path>
        </svg>
        <input type="text" id="globalSearchInput" class="search-input" placeholder="Search by ID or item name...">
      </div>
      <button id="globalSearchBtn" class="btn-primary">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path>
        </svg>
        Search
      </button>
    </div>

    <!-- Category Selector -->
    <div id="categorySection" class="category-section">
      <label class="category-label">Select a category:</label>
      <select id="categoryDropdown" class="select-field">
        <option value="">-- Choose Category --</option>
        <option value="clothes related">üß• Clothes</option>
        <option value="study related">üìö Study</option>
        <option value="cosmetics related">üß¥ Cosmetics</option>
        <option value="electronics related">üíª Electronics</option>
        <option value="others">üß∫ Others</option>
      </select>
    </div>

    <!-- Back Button -->
    <div id="backSection" class="back-section">
      <button id="backBtn" class="btn-secondary">‚¨ÖÔ∏è Back to Categories</button>
    </div>

    <!-- Status -->
    <div id="status" class="status">Loading items‚Ä¶</div>

    <!-- Items Section -->
    <section id="itemsSection" class="items-section">
      <h2 id="categoryTitle" class="category-title"></h2>

      <!-- Category Search -->
      <div id="categorySearch" class="search-container">
        <div class="search-wrapper">
          <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path>
          </svg>
          <input type="text" id="categorySearchInput" class="search-input" placeholder="Search within category...">
        </div>
        <button id="categorySearchBtn" class="btn-primary">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path>
          </svg>
          Search
        </button>
      </div>

      <div id="itemsGrid" class="items-grid"></div>
      <div id="loadMore" class="load-more"><span class="spinner"></span>Loading more items...</div>
    </section>
  </div>

  <!-- Image Viewer Modal -->
  <div id="imageViewer" class="modal-overlay">
    <div class="image-viewer-controls">
      <button id="prevBtn" class="viewer-btn" title="Previous">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"></polyline></svg>
      </button>
      <button id="nextBtn" class="viewer-btn" title="Next">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
      </button>
      <button id="zoomInBtn" class="viewer-btn" title="Zoom in (+)">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
          <path d="M11 8v6M8 11h6"></path>
        </svg>
      </button>
      <button id="zoomOutBtn" class="viewer-btn" title="Zoom out (-)">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
          <path d="M8 11h6"></path>
        </svg>
      </button>
      <button id="rotateBtn" class="viewer-btn" title="Rotate">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"></path>
          <path d="M21 3v5h-5"></path>
        </svg>
      </button>
      <button id="closeImageBtn" class="viewer-btn close" title="Close (Esc)">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18M6 6l12 12"></path></svg>
      </button>
    </div>
    <div class="image-viewer-content"><img id="viewerImage" src="" alt=""></div>
    <div class="image-viewer-info">Zoom: <span id="zoomLevel">100</span>% | Use +/- keys to zoom</div>
  </div>

  <!-- Archive Viewer Modal -->
  <div id="archiveViewer" class="modal-overlay archive-viewer">
    <button id="closeArchiveBtn" class="viewer-btn close">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18M6 6l12 12"></path></svg>Close
    </button>
    <iframe id="archiveFrame" src=""></iframe>
  </div>

  <!-- Order Modal -->
  <div id="orderModal" class="modal-overlay">
    <div class="order-modal-content">
      <div class="order-modal-header">
        <h2>üìù Place Your Order</h2>
        <button id="closeOrderBtn" class="close-modal">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18M6 6l12 12"></path></svg>
        </button>
      </div>
      <p id="orderItemName" class="order-item-name"></p>
      <form id="orderForm" class="order-form">
        <input type="text" id="nameInput" class="input-field" placeholder="Your name *" required>
        <select id="genderInput" class="input-field" required>
          <option value="">Select gender *</option>
          <option value="Male">Male</option>
          <option value="Female">Female</option>
        </select>
        <input type="tel" id="phone1Input" class="input-field" placeholder="Phone number 1 *" required>
        <input type="tel" id="phone2Input" class="input-field" placeholder="Phone number 2 (optional)">
        <p id="orderMessage" class="order-message"></p>
        <div class="form-buttons">
          <button type="submit" id="submitOrderBtn" class="btn-primary">Submit Order</button>
          <button type="button" id="cancelOrderBtn" class="btn-secondary">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Feedback Floating Button & Modal -->
  <button id="feedbackBtn" class="feedback-btn">üí¨</button>
  <div id="feedbackModal" class="modal-overlay">
    <div class="order-modal-content">
      <div class="order-modal-header">
        <h2>Feedback</h2>
        <button id="closeFeedbackBtn" class="close-modal">
          <svg width="20" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18M6 6l12 12"></path></svg>
        </button>
      </div>
      <p>üîê Login or sign up with GitHub to give the feedback.</p>
      <p>üì∫ Or click the video link <a href="https://archive.org/details/panfda" target="_blank" rel="noopener">here</a> to know how to give feedback.</p>
      <p id="countdown" style="text-align:center;font-size:1.5rem;margin-top:12px;">5</p>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer">¬© 2026 Shopping Hub¬∑ Built with ‚ù§Ô∏è by YAN</footer>

  <script>
    /* ------- Configuration ------- */
    const BACKEND_URL = "https://shopping_items_displaying_order_backend.ecetue.workers.dev";
    const LOAD_BATCH   = 30;
    const FALLBACK_IMAGE = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='400' height='300'><rect width='100%' height='100%' fill='%231e293b'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='%2394a3b8' font-family='Arial' font-size='18'>No Image</text></svg>";

    /* ------- State ------- */
    let allItems      = [];
    let filteredItems = [];
    let loadedCount   = 0;
    let selectedItem  = null;
    let imageScale    = 1;
    let imageRotation = 0;
    let isSearchMode  = false;
    let viewerImages  = [];
    let viewerIndex   = 0;
    let feedbackInterval = null;

    /* ------- Elements ------- */
    const statusEl            = document.getElementById('status');
    const categorySection     = document.getElementById('categorySection');
    const categoryDropdown    = document.getElementById('categoryDropdown');
    const backSection         = document.getElementById('backSection');
    const backBtn             = document.getElementById('backBtn');
    const itemsSection        = document.getElementById('itemsSection');
    const itemsGrid           = document.getElementById('itemsGrid');
    const categoryTitle       = document.getElementById('categoryTitle');
    const loadMore            = document.getElementById('loadMore');
    const globalSearch        = document.getElementById('globalSearch');
    const globalSearchInput   = document.getElementById('globalSearchInput');
    const globalSearchBtn     = document.getElementById('globalSearchBtn');
    const categorySearch      = document.getElementById('categorySearch');
    const categorySearchInput = document.getElementById('categorySearchInput');
    const categorySearchBtn   = document.getElementById('categorySearchBtn');

    // Image viewer
    const imageViewer   = document.getElementById('imageViewer');
    const viewerImage   = document.getElementById('viewerImage');
    const zoomLevel     = document.getElementById('zoomLevel');
    const zoomInBtn     = document.getElementById('zoomInBtn');
    const zoomOutBtn    = document.getElementById('zoomOutBtn');
    const rotateBtn     = document.getElementById('rotateBtn');
    const closeImageBtn = document.getElementById('closeImageBtn');
    const prevBtn       = document.getElementById('prevBtn');
    const nextBtn       = document.getElementById('nextBtn');

    // Archive viewer
    const archiveViewer = document.getElementById('archiveViewer');
    const archiveFrame  = document.getElementById('archiveFrame');
    const closeArchiveBtn = document.getElementById('closeArchiveBtn');

    // Order modal
    const orderModal     = document.getElementById('orderModal');
    const orderItemName  = document.getElementById('orderItemName');
    const orderForm      = document.getElementById('orderForm');
    const orderMessage   = document.getElementById('orderMessage');
    const closeOrderBtn  = document.getElementById('closeOrderBtn');
    const cancelOrderBtn = document.getElementById('cancelOrderBtn');
    const submitOrderBtn = document.getElementById('submitOrderBtn');

    // Feedback
    const feedbackBtn      = document.getElementById('feedbackBtn');
    const feedbackModal    = document.getElementById('feedbackModal');
    const closeFeedbackBtn = document.getElementById('closeFeedbackBtn');
    const countdownEl     = document.getElementById('countdown');

    /* ------- Helpers ------- */
    function resolveArchiveImage(url){
      if(!url) return FALLBACK_IMAGE;
      if(/\.(jpe?g|png|gif|webp)$/i.test(url)) return url;
      if(url.includes("archive.org/details/")){
        const id = url.split("details/")[1]?.split(/[/?#]/)[0];
        if(id) return `https://archive.org/services/img/${id}`;
      }
      if(url.includes("archive.org/download/")){
        const id = url.split("download/")[1]?.split(/[/?#]/)[0];
        if(id) return `https://archive.org/services/img/${id.split("/")[0]}`;
      }
      return FALLBACK_IMAGE;
    }
    function embedArchiveUrl(url){
      if(!url) return "";
      let id=null;
      if(url.includes("archive.org/details/")) id = url.split("details/")[1]?.split(/[/?#]/)[0];
      else if(url.includes("archive.org/download/")) id = url.split("download/")[1]?.split(/[/?#]/)[0];
      return id ? `https://archive.org/embed/${id}` : url;
    }
    function getImageUrls(item){
      if(!item.archive_url) return [];
      if(Array.isArray(item.archive_url)){
        return item.archive_url.map(resolveArchiveImage).filter(Boolean);
      }
      return item.archive_url.split(/[,\s]+/).filter(Boolean).map(resolveArchiveImage);
    }
    function linkifyText(text){
      if(text===null||text===undefined) return "N/A";
      const str = String(text);
      const urlRegex = /(https?:\/\/[^\s<>]+)|(www\.[^\s<>]+)/gi;
      return str.replace(urlRegex, url => {
        let href = url;
        if(!/^https?:\/\//i.test(href)) href = "https://"+href;
        return `<a href="${href}" target="_blank" rel="noopener noreferrer">${url}</a>`;
      });
    }
    function escapeHtml(text){
      if(text===null||text===undefined) return "N/A";
      return String(text).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
    }

    /* ------- Data Fetch ------- */
    async function fetchItems(){
      statusEl.textContent = "Loading items‚Ä¶";
      try{
        const res = await fetch(BACKEND_URL);
        if(!res.ok) throw new Error("Backend error: "+res.status);
        const data = await res.json();
        allItems = Array.isArray(data)
          ? data.sort((a,b)=>{ const idA=parseInt(a.id)||0; const idB=parseInt(b.id)||0; return idB-idA; })
          : [];
        statusEl.textContent = "‚úÖ Items loaded successfully!";
        initFromURL();   // handle possible item_id param
      }catch(err){
        console.error(err);
        statusEl.textContent = "‚ùå Failed to load items.";
        allItems=[];
      }
    }

    /* ------- Rendering Helpers ------- */
    function buildDetailsHtml(item){
      const exclude = ["item","archive_url"];
      let html = '<div class="details-scrollable">';
      for(const [k,v] of Object.entries(item)){
        if(exclude.includes(k)) continue;
        const key = k.replace(/_/g," ");
        let value;
        if(v===null||v===undefined) value = '<span style="color:#64748b;">N/A</span>';
        else if(typeof v==="object") value = `<pre>${escapeHtml(JSON.stringify(v,null,2))}</pre>`;
        else value = linkifyText(escapeHtml(String(v)));
        html+=`
          <div class="detail-row">
            <span class="detail-key">${escapeHtml(key)}:</span>
            <span class="detail-value">${value}</span>
          </div>`;
      }
      html+='</div>';
      return html;
    }

    function createCard(item){
      const title   = item.item || "(no title)";
      const images  = getImageUrls(item);
      const preview = images[0] || FALLBACK_IMAGE;
      const price   = item.price || item.total_price || "N/A";
      const stock   = item.stock;
      const stockNum = typeof stock==="number"?stock:parseInt(String(stock));
      const outOfStock = !isNaN(stockNum) && stockNum<=0;

      const card = document.createElement("div");
      card.className="item-card";
      card.dataset.id = item.id;
      card.innerHTML=`
        <div class="image-container">
          <img src="${preview}" alt="${escapeHtml(title)}" class="item-image" loading="lazy">
          <button class="zoom-btn" title="View fullscreen">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="m21 21-6-6m6 6v-4.8m0 4.8h-4.8"></path>
              <path d="M3 16.2V21m0 0h4.8M3 21l6-6"></path>
              <path d="M21 7.8V3m0 0h-4.8M21 3l-6 6"></path>
              <path d="M3 7.8V3m0 0h4.8M3 3l6 6"></path>
            </svg>
          </button>
        </div>
        <div class="card-content">
          <h3 class="item-title">${escapeHtml(title)}</h3>
          <div class="item-price">‚Çπ${escapeHtml(String(price))}</div>
          ${buildDetailsHtml(item)}
          <div class="card-actions">
            ${item.archive_url?`<button class="btn-success archive-btn">üìÅ View in Archive</button>`:""}
            <button class="btn-order order-btn"${outOfStock?" disabled":""}>${outOfStock?"Out of Stock":"Order Now"}</button>
            <button class="btn-secondary share-btn">üîó Share</button>
          </div>
        </div>`;

      // Zoom (image viewer)
      card.querySelector(".zoom-btn").addEventListener("click",e=>{
        e.stopPropagation();
        openImageViewer(images,title);
      });

      // Archive button
      const archiveBtn=card.querySelector(".archive-btn");
      if(archiveBtn){
        const firstArchive = Array.isArray(item.archive_url)?item.archive_url[0]:item.archive_url;
        archiveBtn.addEventListener("click",()=>openArchiveViewer(firstArchive));
      }

      // Order button
      const orderBtn=card.querySelector(".order-btn");
      if(!outOfStock){
        orderBtn.addEventListener("click",()=>openOrderModal(item));
      }

      // Share button
      const shareBtn=card.querySelector(".share-btn");
      shareBtn.addEventListener("click",e=>{
        e.stopPropagation();
        const base = "https://yan-1-related-1.github.io/yan-1-website-shared-links-redirecting/shopping-page-shared-links-redirecting.html?item_id=";
        const link = base + encodeURIComponent(item.id);
        if (navigator.share) {
          navigator.share({title: item.item || "Item", url: link})
            .catch(err=>console.warn("Web Share failed:", err));
        } else if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(link)
            .then(()=>alert("Share link copied to clipboard!"))
            .catch(()=>prompt("Copy the link", link));
        } else {
          prompt("Copy the link", link);
        }
      });

      return card;
    }

    function renderItems(arr){
      itemsGrid.innerHTML="";
      loadedCount=0;
      filteredItems=arr;
      if(arr.length===0){
        itemsGrid.innerHTML='<div class="no-items">No items found.</div>';
        return;
      }
      loadMoreItems();
    }

    function loadMoreItems(){
      if(loadedCount>=filteredItems.length) return;
      loadMore.style.display="block";
      const batch = filteredItems.slice(loadedCount,loadedCount+LOAD_BATCH);
      batch.forEach(it=>itemsGrid.appendChild(createCard(it)));
      loadedCount+=batch.length;
      setTimeout(()=>{loadMore.style.display="none";},300);
    }

    /* ------- Scroll Handling ------- */
    function handleScroll(){
      if(window.innerHeight+window.scrollY>=document.body.offsetHeight-200){
        loadMoreItems();
      }
    }

    /* ------- Category / Search Logic ------- */
    const CATEGORY_LABELS = {
      "clothes related":"üß• Clothes",
      "study related":"üìö Study",
      "cosmetics related":"üß¥ Cosmetics",
      "electronics related":"üíª Electronics",
      "others":"üß∫ Others"
    };

    function showCategory(cat){
      const arr = allItems.filter(i=> (i.type||"").toLowerCase()===cat);
      categoryTitle.textContent = CATEGORY_LABELS[cat] || "Items";
      categorySearchInput.value="";
      renderItems(arr);
      categorySection.style.display="none";
      globalSearch.style.display="none";
      backSection.style.display="block";
      itemsSection.style.display="block";
      isSearchMode=false;
      window.addEventListener("scroll",handleScroll);
    }

    function performGlobalSearch(q){
      const term = q.toLowerCase().trim();
      if(!term) return;
      const results = allItems.filter(it=>{
        const idMatch   = String(it.id).toLowerCase().includes(term);
        const nameMatch = (it.item||"").toLowerCase().includes(term);
        return idMatch||nameMatch;
      });
      categoryTitle.textContent = `üîç Search results for "${q}"`;
      categorySearchInput.value="";
      renderItems(results);
      categorySection.style.display="none";
      globalSearch.style.display="none";
      backSection.style.display="block";
      itemsSection.style.display="block";
      isSearchMode=true;
      window.addEventListener("scroll",handleScroll);
    }

    function performCategorySearch(q){
      const term = q.toLowerCase().trim();
      let arr=[];
      if(isSearchMode){
        arr = filteredItems.filter(it=>{
          const idMatch   = String(it.id).toLowerCase().includes(term);
          const nameMatch = (it.item||"").toLowerCase().includes(term);
          return idMatch||nameMatch;
        });
      }else{
        const cat = categoryDropdown.value;
        arr = allItems.filter(i=> (i.type||"").toLowerCase()===cat);
        if(term){
          arr = arr.filter(it=>{
            const idMatch   = String(it.id).toLowerCase().includes(term);
            const nameMatch = (it.item||"").toLowerCase().includes(term);
            return idMatch||nameMatch;
          });
        }
      }
      renderItems(arr);
    }

    function goBack(){
      itemsGrid.innerHTML="";
      itemsSection.style.display="none";
      backSection.style.display="none";
      categorySection.style.display="block";
      globalSearch.style.display="flex";
      categoryDropdown.value="";
      globalSearchInput.value="";
      isSearchMode=false;
      window.removeEventListener("scroll",handleScroll);
    }

    /* ------- Image Viewer ------- */
    function openImageViewer(urls,title,startIdx=0){
      if(!Array.isArray(urls)||urls.length===0) return;
      viewerImages = urls;
      viewerIndex = startIdx;
      imageScale = 1;
      imageRotation = 0;
      updateViewerImage(title);
      imageViewer.classList.add("active");
    }
    function updateViewerImage(title=""){
      viewerImage.src = viewerImages[viewerIndex];
      viewerImage.alt = title;
      viewerImage.style.transform = `scale(${imageScale}) rotate(${imageRotation}deg)`;
      zoomLevel.textContent = Math.round(imageScale*100);
    }
    function closeImageViewer(){ imageViewer.classList.remove("active"); viewerImage.src=""; }

    zoomInBtn.addEventListener("click",e=>{e.stopPropagation(); imageScale=Math.min(imageScale+0.5,4); updateViewerImage();});
    zoomOutBtn.addEventListener("click",e=>{e.stopPropagation(); imageScale=Math.max(imageScale-0.5,0.5); updateViewerImage();});
    rotateBtn.addEventListener("click",e=>{e.stopPropagation(); imageRotation=(imageRotation+90)%360; updateViewerImage();});
    closeImageBtn.addEventListener("click",closeImageViewer);
    imageViewer.addEventListener("click",e=>{if(e.target===imageViewer) closeImageViewer();});
    prevBtn.addEventListener("click",e=>{e.stopPropagation(); viewerIndex=(viewerIndex-1+viewerImages.length)%viewerImages.length; updateViewerImage();});
    nextBtn.addEventListener("click",e=>{e.stopPropagation(); viewerIndex=(viewerIndex+1)%viewerImages.length; updateViewerImage();});

    /* ------- Archive Viewer ------- */
    function openArchiveViewer(url){
      const embed = embedArchiveUrl(url);
      archiveFrame.src = embed;
      archiveViewer.classList.add("active");
    }
    function closeArchiveViewer(){ archiveViewer.classList.remove("active"); archiveFrame.src=""; }
    closeArchiveBtn.addEventListener("click",closeArchiveViewer);

    /* ------- Order Modal ------- */
    function openOrderModal(item){
      selectedItem=item;
      orderItemName.textContent=`Item: ${item.item}`;
      orderForm.reset();
      orderMessage.textContent="";
      orderMessage.className="order-message";
      orderModal.classList.add("active");
    }
    function closeOrderModal(){ orderModal.classList.remove("active"); selectedItem=null; }

    async function submitOrder(e){
      e.preventDefault();
      if(!selectedItem) return;
      const name   = document.getElementById("nameInput").value.trim();
      const gender = document.getElementById("genderInput").value;
      const phone1 = document.getElementById("phone1Input").value.trim();
      const phone2 = document.getElementById("phone2Input").value.trim();

      if(!name||!gender||!phone1){
        orderMessage.textContent="Please fill all required fields.";
        orderMessage.className="order-message error";
        return;
      }

      const payload = {
        id:selectedItem.id,
        item:selectedItem.item,
        type:selectedItem.type,
        price:selectedItem.total_price||selectedItem.price||"N/A",
        archive_url:selectedItem.archive_url,
        name,gender,
        phone_number_1:phone1,
        phone_number_2:phone2||null,
        date:new Date().toISOString().split("T")[0],
        stock: Math.max((parseInt(selectedItem.stock)||0)-1,0)
      };

      submitOrderBtn.disabled=true;
      submitOrderBtn.textContent="Submitting...";

      try{
        const res = await fetch(BACKEND_URL,{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify(payload)
        });
        if(!res.ok) throw new Error(await res.text());

        orderMessage.textContent="‚úÖ Order submitted successfully!";
        orderMessage.className="order-message success";

        setTimeout(()=>{
          closeOrderModal();
          fetchItems().then(()=>{
            if(categoryDropdown.value && !isSearchMode){
              const arr = allItems.filter(i=> (i.type||"").toLowerCase()===categoryDropdown.value);
              renderItems(arr);
            }
          });
        },1000);
      }catch(err){
        console.error(err);
        orderMessage.textContent="‚ùå Failed to submit order.";
        orderMessage.className="order-message error";
      }finally{
        submitOrderBtn.disabled=false;
        submitOrderBtn.textContent="Submit Order";
      }
    }

    /* ------- Feedback Modal ------- */
    function openFeedbackModal(){
      feedbackModal.classList.add("active");
      let sec = 5;
      countdownEl.textContent = sec;
      feedbackInterval = setInterval(()=>{
        sec--;
        if(sec>0){
          countdownEl.textContent = sec;
        }else{
          clearInterval(feedbackInterval);
          feedbackModal.classList.remove("active");
          window.open("https://github.com/OpenThoughtVoice/OpenThoughtVoice/discussions/6","_blank");
        }
      },1000);
    }
    function closeFeedbackModal(){
      feedbackModal.classList.remove("active");
      if(feedbackInterval) clearInterval(feedbackInterval);
    }

    /* ------- Event Listeners ------- */
    categoryDropdown.addEventListener("change",()=>{ const cat=categoryDropdown.value; if(cat) showCategory(cat); });
    backBtn.addEventListener("click",goBack);
    globalSearchBtn.addEventListener("click",()=>performGlobalSearch(globalSearchInput.value));
    globalSearchInput.addEventListener("keydown",e=>{ if(e.key==="Enter") performGlobalSearch(globalSearchInput.value); });
    categorySearchBtn.addEventListener("click",()=>performCategorySearch(categorySearchInput.value));
    categorySearchInput.addEventListener("keydown",e=>{ if(e.key==="Enter") performCategorySearch(categorySearchInput.value); });

    closeOrderBtn.addEventListener("click",closeOrderModal);
    cancelOrderBtn.addEventListener("click",closeOrderModal);
    orderModal.addEventListener("click",e=>{ if(e.target===orderModal) closeOrderModal(); });
    orderForm.addEventListener("submit",submitOrder);

    feedbackBtn.addEventListener("click",openFeedbackModal);
    closeFeedbackBtn.addEventListener("click",closeFeedbackModal);

    /* ------- Keyboard Shortcuts ------- */
    window.addEventListener("keydown",e=>{
      if(e.key==="Escape"){
        closeImageViewer(); closeArchiveViewer(); closeOrderModal(); closeFeedbackModal();
      }
      if(imageViewer.classList.contains("active")){
        if(e.key==="+"||e.key==="="){
          imageScale=Math.min(imageScale+0.25,4); updateViewerImage();
        }
        if(e.key==="-" ){
          imageScale=Math.max(imageScale-0.25,0.5); updateViewerImage();
        }
      }
    });

    /* ------- URL Direct Link Handling ------- */
    function initFromURL(){
      const params = new URLSearchParams(window.location.search);
      const itemId = params.get("item_id");
      if(!itemId) return;
      const item = allItems.find(i=>String(i.id)===itemId);
      if(!item) return;
      const cat = (item.type||"").toLowerCase();
      categoryDropdown.value = cat;
      showCategory(cat);

      const tryScroll = setInterval(()=>{
        const card = document.querySelector(`.item-card[data-id="${itemId}"]`);
        if(card){
          card.scrollIntoView({behavior:"smooth",block:"center"});
          card.style.border = "2px solid #2563eb";
          setTimeout(()=>card.style.border="1px solid #d1d5db",2000);
          clearInterval(tryScroll);
        }else if(loadedCount < filteredItems.length){
          loadMoreItems();
        }
      },500);
      setTimeout(()=>clearInterval(tryScroll),12000);
    }

    /* ------- Initialise ------- */
    window.addEventListener("DOMContentLoaded",fetchItems);
  </script>
</body>
</html>
